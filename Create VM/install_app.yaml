- name: Install and configure Nginx, MySQL and PHP
  include_vars:
    file: create_centos_vm.yml
  hosts: "{{ instance_ip }}"
  become: true
  gather_facts: yes
  tasks:
    - name: Install Nginx, MariaDB and PHP
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - nginx
        - mariadb-server
        - php-fpm

    - name: Configure Nginx
      template:
        src: nginx.conf.j2
        dest: /etc/nginx/nginx.conf
      notify: Restart Nginx

    - name: Configure PHP
      template:
        src: php.ini.j2
        dest: /etc/php.ini
      notify: Restart PHP-FPM

  handlers:
    - name: Restart Nginx
      service:
        name: nginx
        state: restarted

    - name: Restart PHP-FPM
      service:
        name: php-fpm
        state: restarted
